# Как сделать reset RabbitMQ?

Иногда бывает необходимо просто удалить всё с сервера RabbitMQ и запустить его заново, в "чистом" виде. 
Несмотря на то, что RabbitMQ чрезвычайно стабилен, в некоторых редких случаях требуется полностью сбросить RabbitMQ после обнаружения таких ошибок, как, например, 
поврежденные данные, или ноды, окончательно выпавшие из кластера, и тому подобное. На самом деле - не нужно ничего "переустанавливать", всё делается быстро и просто.
Проще всего удалить и пересоздать `vhost`, который навсегда очистит все объекты, такие как очереди, полиcи, биндинги и т. д. Как это сделать, и как использовать 
`reset` и `force_reset`.

## Пересоздание виртуального хоста из командной строки

Чтобы удалить поврежденные данные не нужно перезагружать ноду RabbitMQ, удаление виртуального хоста удалит все данные из БД, сохраняя при этом состояние кластера 
и информацию о пользователях.

Чтобы удалить виртуальный хост с именем `reset_vhost`:

    delete_vhost reset_vhost
    add_vhost reset_vhost
    
Эти команды удаляют и добавляют reset_vhost. Все связанные queues, exchanges и messages удаляются из брокера, не затрагивая пользователей.

## Пересоздание виртуального хоста из консоли управления (web-интерфейса)

Консоль управления позволяет удалять и создавать виртуальные хосты без использования командной строки. В качестве примера у нас есть очередь `reset_queue` и обменник `reset_exchange`.

Очередь и обменник находятся на виртуальным хосте с именем reset_vhost, как показано на рисунке ниже:

![](https://www.cloudamqp.com/img/blog/reset-vhost.png)

Кликните по виртуальному хосту `reset_vhost`, а затем нажмите кнопку `"Delete this Virtual Host"` внизу страницы. Нажмите ОК, если RabbitMQ запросит подтверждение.

![](https://www.cloudamqp.com/img/blog/reset-rabbitmq-broker.png)

Брокер удалит виртуальный хост и всю связанную с ним структуру. Действие не повлияет на подключенных пользователей, оно просто удаляет виртуальный хост.

## Как сбросить мою ноду RabbitMQ?
В RabbitMQ есть команды `reset` и `force_reset`, которые можно выполнить через [rabbitmqctl](https://www.rabbitmq.com/rabbitmqctl.8.html) для сброса одной ноды. 
Выполните следующие команды, чтобы корректно перезагрузить сервер:

    rabbitmqctl stop_app
    rabbitmqctl reset
    rabbitmqctl start_app
    
Брокер удалит все виртуальные хосты, очереди, обменники и пользователей без прав администратора. RabbitMQ попытается корректно завершить работу, не повредив существующий кластер или брокер, и вернется в исходное состояние.

## Что делать, если кластер RabbitMQ поврежден?

Если ваш кластер поврежден или безвозвратно split, используйте `force_reset` вместо сброса. Это автоматически удалит ваши очереди, обменники и конфигурации. 
Выполните следующее из командной строки на целевом узле:
    
    rabbitmqctl stop_app
    rabbitmqctl force_reset
    rabbitmqctl start_app
    
Вам все равно нужно остановить и перезапустить приложение. Используйте эту команду только в крайнем случае, когда база данных или кластер повреждены, поскольку попыток уведомить другие узлы не будет. 
Любая команда сброса приводит к удалению всех пользователей, кроме администратора и любых сообщений.

## Что произойдет, если я дропну виртуальный хост на ноде кластера?
Кластеры пытаются синхронизировать информацию. Если вы дропаете виртуальный хост, действие распространяется на весь кластер. 
Все брокеры также удаляют связанные очереди, обменники и сообщения.

Сброс ноды удаляет её из кластера. Виртуальный хост и соответствующая информация остаются в кластере. При необходимости вам нужно будет удалить виртуальные хосты на кластере. 
Если вы не дропнете виртуальный хост, он будет воссоздан при повторном присоединении к кластеру.

Оригинал: https://www.cloudamqp.com/blog/how-to-reset-the-rabbitmq-broker.html
